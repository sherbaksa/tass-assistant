{% extends 'base.html' %}
{% block content %}
<h1>{{ title }}</h1>

<p class="page__intro">
  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–µ–∂–µ—Å—Ç–∏ –Ω–æ–≤–æ—Å—Ç–µ–π.
  –í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è <strong>Brave Search API</strong>.
</p>

<div class="card">
  <h2 class="card__title">üîç Brave Search API</h2>
  
  <form method="post" action="{{ url_for('settings.update_search_settings') }}" class="form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div>
      <label class="label" for="api_key">API –∫–ª—é—á</label>
      <input type="text"
             id="api_key"
             name="api_key"
             class="input"
             value="{{ api_key or '' }}"
             placeholder="BSAxxxxxxxxxxxxxxxxxxxxxxxxxx">
      <div class="help">
        –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞ <a href="https://brave.com/search/api/" target="_blank">brave.com/search/api</a>
        <br>
        <strong>Free tier:</strong> 2,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ
      </div>
    </div>

    <div>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox"
               name="is_enabled"
               {% if is_enabled %}checked{% endif %}>
        <span>–ü–æ–∏—Å–∫ –≤–∫–ª—é—á—ë–Ω</span>
      </label>
      <div class="help">
        –ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ, —ç—Ç–∞–ø "–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞" –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å—Å—è
      </div>
    </div>

    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
      <button type="submit" class="btn btn--primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" class="btn btn--muted" id="testSearchBtn">üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
      <a href="{{ url_for('settings.index') }}" class="btn btn--muted">–ù–∞–∑–∞–¥</a>
    </div>
  </form>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
  <div id="testResult" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: var(--radius-sm);"></div>
</div>

<div class="card" style="margin-top: 1rem;">
  <h3>üí° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Brave Search API</h3>
  
  <div style="margin-top: 1rem;">
    <h4>–¢–∞—Ä–∏—Ñ—ã:</h4>
    <ul>
      <li><strong>Free:</strong> 2,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å—è—Ü - –±–µ—Å–ø–ª–∞—Ç–Ω–æ</li>
      <li><strong>Pro:</strong> 20,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å—è—Ü - $5/–º–µ—Å—è—Ü</li>
      <li><strong>Pro AI:</strong> 100,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å—è—Ü - $25/–º–µ—Å—è—Ü</li>
    </ul>
  </div>

  <div style="margin-top: 1rem;">
    <h4>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</h4>
    <ul>
      <li>‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∏–Ω–¥–µ–∫—Å (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Google/Bing)</li>
      <li>‚úÖ –•–æ—Ä–æ—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤–æ—Å—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</li>
      <li>‚úÖ –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å–≤–µ–∂–µ—Å—Ç–∏ (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü/–≥–æ–¥)</li>
      <li>‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –∏ —Å—Ç—Ä–∞–Ω</li>
      <li>‚úÖ –ë—ã—Å—Ç—Ä—ã–π –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π API</li>
    </ul>
  </div>

  <div style="margin-top: 1rem;">
    <h4>–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:</h4>
    <ul>
      <li><a href="https://api.search.brave.com/app/documentation/web-search/get-started" target="_blank">Getting Started</a></li>
      <li><a href="https://api.search.brave.com/app/documentation/web-search/codes" target="_blank">API Reference</a></li>
    </ul>
  </div>

  <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,193,7,.1); border: 1px solid rgba(255,193,7,.3); border-radius: var(--radius-sm);">
    <strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong> –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è API –∫–ª—é—á–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ —Ñ–∞–π–ª <code>.env</code> –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è:
    <pre style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,.3); border-radius: 4px;">BRAVE_SEARCH_API_KEY=–≤–∞—à_–∫–ª—é—á_–∑–¥–µ—Å—å
BRAVE_SEARCH_ENABLED=1</pre>
  </div>
</div>

<script>
document.getElementById('testSearchBtn').addEventListener('click', async function() {
  const btn = this;
  const resultDiv = document.getElementById('testResult');
  const apiKeyInput = document.getElementById('api_key');
  const apiKey = apiKeyInput.value.trim();

  if (!apiKey) {
    resultDiv.style.display = 'block';
    resultDiv.style.background = 'rgba(255,193,7,.15)';
    resultDiv.style.border = '1px solid rgba(255,193,7,.3)';
    resultDiv.style.color = 'var(--warn)';
    resultDiv.textContent = '‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
    return;
  }

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
  btn.disabled = true;
  btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  resultDiv.style.display = 'block';
  resultDiv.style.background = 'rgba(255,255,255,.02)';
  resultDiv.style.border = '1px solid var(--tass-border)';
  resultDiv.textContent = '‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Brave Search API...';

  try {
    const formData = new FormData();
    formData.append('api_key', apiKey);

    const response = await fetch('{{ url_for("settings.test_search") }}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: formData
    });

    const data = await response.json();

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if (data.success) {
      resultDiv.style.background = 'rgba(38,208,124,.15)';
      resultDiv.style.border = '1px solid rgba(38,208,124,.3)';
      resultDiv.style.color = 'var(--ok)';
    } else {
      resultDiv.style.background = 'rgba(255,82,82,.15)';
      resultDiv.style.border = '1px solid rgba(255,82,82,.3)';
      resultDiv.style.color = 'var(--err)';
    }

    resultDiv.textContent = data.message;

  } catch (error) {
    resultDiv.style.background = 'rgba(255,82,82,.15)';
    resultDiv.style.border = '1px solid rgba(255,82,82,.3)';
    resultDiv.style.color = 'var(--err)';
    resultDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: ' + error.message;
  } finally {
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    btn.disabled = false;
    btn.textContent = 'üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
  }
});
</script>

{% endblock %}