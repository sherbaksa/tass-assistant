{% extends 'base.html' %}
{% block content %}
<h1>{{ title }}</h1>

<p class="page__intro">
  –ù–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á–∏ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ AI. –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ.
</p>

<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>API –∫–ª—é—á</th>
        <th>–ú–æ–¥–µ–ª–µ–π</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for provider in providers %}
      <tr>
        <td>
          <strong>{{ provider.display_name }}</strong>
          <div class="help">{{ provider.name }}</div>
        </td>
        <td>
          <span class="status">
            <span class="status-dot status-dot--{{ 'active' if provider.is_active else 'inactive' }}"></span>
            {{ '–ê–∫—Ç–∏–≤–µ–Ω' if provider.is_active else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
          </span>
        </td>
        <td>
          {% if provider.api_key %}
            <span class="badge badge--success">–ù–∞—Å—Ç—Ä–æ–µ–Ω</span>
          {% else %}
            <span class="badge badge--warning">–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>
          {% endif %}
        </td>
        <td>
          {{ provider.models.count() }}
        </td>
        <td>
          <div class="table-actions">
            <a href="{{ url_for('assistants.edit_provider', provider_id=provider.id) }}" 
               class="btn btn--sm">
              –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
            </a>
            {% if provider.api_key %}
            <button type="button"
                    class="btn btn--sm btn--muted test-connection-btn"
                    data-provider-id="{{ provider.id }}"
                    data-provider-name="{{ provider.display_name }}">
              üîå –¢–µ—Å—Ç
            </button>
            {% endif %}
            <form action="{{ url_for('assistants.toggle_provider', provider_id=provider.id) }}"
                  method="post" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn--sm btn--muted">
                {{ '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if provider.is_active else '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}
              </button>
            </form>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div style="margin-top: 1.5rem;">
  <a href="{{ url_for('assistants.index') }}" class="btn btn--muted">‚Üê –ù–∞–∑–∞–¥</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const testButtons = document.querySelectorAll('.test-connection-btn');

  testButtons.forEach(btn => {
    btn.addEventListener('click', async function() {
      const providerId = this.dataset.providerId;
      const providerName = this.dataset.providerName;
      const originalText = this.textContent;

      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      this.disabled = true;
      this.textContent = '‚è≥';

      try {
        const response = await fetch(`/assistants/providers/${providerId}/test`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
          }
        });

        const data = await response.json();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ alert (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
        if (data.success) {
          alert(`${providerName}\n\n${data.message}`);
        } else {
          alert(`${providerName}\n\n${data.message}`);
        }

      } catch (error) {
        alert(`${providerName}\n\n‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
      } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        this.disabled = false;
        this.textContent = originalText;
      }
    });
  });
});
</script>
{% endblock %}