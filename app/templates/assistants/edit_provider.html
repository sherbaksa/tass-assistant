{% extends 'base.html' %}
{% block content %}
<h1>{{ title }}</h1>

<p class="page__intro">
  –£–∫–∞–∂–∏—Ç–µ API –∫–ª—é—á –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ <strong>{{ provider.display_name }}</strong>.
  –ö–ª—é—á –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥–µ–ª—è–º —ç—Ç–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
</p>

<div class="card">
  <form method="post" class="form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div>
      <label class="label" for="api_key">API –∫–ª—é—á</label>
      <input type="text"
             id="api_key"
             name="api_key"
             class="input"
             value="{{ provider.api_key or '' }}"
             placeholder="sk-...">
      <div class="help">
        {% if provider.name == 'openai' %}
          –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –Ω–∞ <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
        {% elif provider.name == 'google' %}
          –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –Ω–∞ <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
        {% elif provider.name == 'anthropic' %}
          –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –Ω–∞ <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>
        {% endif %}
      </div>
    </div>

    <div>
      <label class="label" for="base_url">Base URL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input type="text"
             id="base_url"
             name="base_url"
             class="input"
             value="{{ base_url or '' }}"
             placeholder="https://api.openai.com/v1">
      <div class="help">
        –£–∫–∞–∂–∏—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π URL API (–¥–ª—è –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞).
        <br>
        –ü—Ä–∏–º–µ—Ä—ã:
        <code>https://my-proxy.com/v1</code>,
        <code>http://localhost:8080/v1</code>
        <br>
        –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π URL –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
      </div>
    </div>

    <div>
      <label class="label" for="additional_config">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (JSON)</label>
      <textarea id="additional_config"
                name="additional_config"
                class="textarea"
                placeholder='{"organization_id": "org-...", "project_id": "..."}'
      >{{ provider.additional_config or '' }}</textarea>
      <div class="help">
        –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (organization_id, project_id –∏ —Ç.–¥.)
        <br>
        <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω Base URL –≤—ã—à–µ, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—Å—è –≤ —ç—Ç—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.
      </div>
    </div>

    <div>
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input type="checkbox"
               name="is_active"
               {% if provider.is_active %}checked{% endif %}>
        <span>–ü—Ä–æ–≤–∞–π–¥–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω</span>
      </label>
    </div>

    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
      <button type="submit" class="btn btn--primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" class="btn btn--muted" id="testConnectionBtn">üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
      <a href="{{ url_for('assistants.providers') }}" class="btn btn--muted">–û—Ç–º–µ–Ω–∞</a>
    </div>
  </form>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
  <div id="testResult" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: var(--radius-sm);"></div>
</div>

<script>
document.getElementById('testConnectionBtn').addEventListener('click', async function() {
  const btn = this;
  const resultDiv = document.getElementById('testResult');

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
  btn.disabled = true;
  btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  resultDiv.style.display = 'block';
  resultDiv.style.background = 'rgba(255,255,255,.02)';
  resultDiv.style.border = '1px solid var(--tass-border)';
  resultDiv.textContent = '‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API...';

  try {
    const response = await fetch('{{ url_for("assistants.test_provider", provider_id=provider.id) }}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token() }}'
      }
    });

    const data = await response.json();

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if (data.success) {
      resultDiv.style.background = 'rgba(38,208,124,.15)';
      resultDiv.style.border = '1px solid rgba(38,208,124,.3)';
      resultDiv.style.color = 'var(--ok)';
    } else {
      resultDiv.style.background = 'rgba(255,82,82,.15)';
      resultDiv.style.border = '1px solid rgba(255,82,82,.3)';
      resultDiv.style.color = 'var(--err)';
    }

    resultDiv.textContent = data.message;

  } catch (error) {
    resultDiv.style.background = 'rgba(255,82,82,.15)';
    resultDiv.style.border = '1px solid rgba(255,82,82,.3)';
    resultDiv.style.color = 'var(--err)';
    resultDiv.textContent = '‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: ' + error.message;
  } finally {
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    btn.disabled = false;
    btn.textContent = 'üîå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
  }
});
</script>

<div class="card" style="margin-top: 1rem;">
  <h3>üí° –°–ø—Ä–∞–≤–∫–∞ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º</h3>

  {% if provider.name == 'openai' %}
    <p><strong>OpenAI:</strong></p>
    <ul>
      <li>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π URL: <code>https://api.openai.com/v1</code></li>
      <li>–î–ª—è –ø—Ä–æ–∫—Å–∏ —É–∫–∞–∂–∏—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π Base URL</li>
      <li>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: <code>organization_id</code>, <code>project_id</code></li>
    </ul>
  {% elif provider.name == 'google' %}
    <p><strong>Google AI (Gemini):</strong></p>
    <ul>
      <li>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π URL: <code>https://generativelanguage.googleapis.com</code></li>
      <li>API –∫–ª—é—á –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞</li>
      <li>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: <code>project_id</code></li>
    </ul>
  {% elif provider.name == 'anthropic' %}
    <p><strong>Anthropic (Claude):</strong></p>
    <ul>
      <li>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π URL: <code>https://api.anthropic.com</code></li>
      <li>–î–ª—è –ø—Ä–æ–∫—Å–∏ —É–∫–∞–∂–∏—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π Base URL</li>
      <li>–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–µ—Ä—Å–∏—è API –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö</li>
    </ul>
  {% endif %}
</div>
{% endblock %}