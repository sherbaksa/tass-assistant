"""
–°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
"""
from app.app import create_app
from app.models import Stage, SystemPrompt, User
from app.services.prompt_manager import PromptManager
from app.extensions import db

# –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
DEFAULT_PROMPTS = {
    'classification': {
        'description': '–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
        'prompt': '''–í—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞. 
–í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –Ω–æ–≤–æ—Å—Ç—å –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
- –ü–æ–ª–∏—Ç–∏–∫–∞
- –≠–∫–æ–Ω–æ–º–∏–∫–∞
- –û–±—â–µ—Å—Ç–≤–æ
- –ö—É–ª—å—Ç—É—Ä–∞
- –°–ø–æ—Ä—Ç
- –ù–∞—É–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- –ü—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è

–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
–ï—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç—å –º–æ–∂–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —É–∫–∞–∂–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: [–∫–∞—Ç–µ–≥–æ—Ä–∏—è]
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ: [–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –µ—Å–ª–∏ –µ—Å—Ç—å]
–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: [–≤—ã—Å–æ–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–Ω–∏–∑–∫–∞—è]
–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: [–∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ]'''
    },
    'freshness_check': {
        'description': '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —Å–≤–µ–∂–µ—Å—Ç–∏ –Ω–æ–≤–æ—Å—Ç–∏',
        'prompt': '''–í—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.
–í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –æ—Ü–µ–Ω–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∏ —Å–≤–µ–∂–µ—Å—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –Ω–æ–≤–æ—Å—Ç–∏.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ:
1. –î–∞—Ç—É —Å–æ–±—ã—Ç–∏—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)
2. –•–∞—Ä–∞–∫—Ç–µ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Å—Ä–æ—á–Ω–∞—è/–ø–ª–∞–Ω–æ–≤–∞—è/–∞—Ä—Ö–∏–≤–Ω–∞—è)
3. –ù–∞–ª–∏—á–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
4. –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–°—Ç–∞—Ç—É—Å: [—Å–≤–µ–∂–∞—è/–∞–∫—Ç—É–∞–ª—å–Ω–∞—è/—É—Å—Ç–∞—Ä–µ–≤—à–∞—è/–∞—Ä—Ö–∏–≤–Ω–∞—è]
–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è: [–¥–∞—Ç–∞ –∏–ª–∏ "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"]
–°—Ä–æ—á–Ω–æ—Å—Ç—å: [–≤—ã—Å–æ–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–Ω–∏–∑–∫–∞—è]
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: [–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å]
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: [–∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ]'''
    },
    'analysis': {
        'description': '–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–∏',
        'prompt': '''–í—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.
–í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –Ω–æ–≤–æ—Å—Ç–∏.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ:
1. –ü–æ–ª–Ω–æ—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–µ—Å—Ç—å –ª–∏ –≤—Å–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏)
2. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ (—É–∫–∞–∑–∞–Ω—ã –ª–∏, –Ω–∞—Å–∫–æ–ª—å–∫–æ –Ω–∞–¥—ë–∂–Ω—ã)
3. –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è/–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è/–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è)
4. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏)
5. –Ø–∑—ã–∫–æ–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (–≥—Ä–∞–º–º–∞—Ç–∏–∫–∞, —Å—Ç–∏–ª—å, —á–∏—Ç–∞–µ–º–æ—Å—Ç—å)

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–ü–æ–ª–Ω–æ—Ç–∞: [–ø–æ–ª–Ω–∞—è/–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è/–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è]
–ò—Å—Ç–æ—á–Ω–∏–∫–∏: [—É–∫–∞–∑–∞–Ω—ã/—á–∞—Å—Ç–∏—á–Ω–æ/–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç]
–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: [—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞]
–ö–∞—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–∞: [–æ—Ü–µ–Ω–∫–∞]
–ü—Ä–æ–±–ª–µ–º—ã: [—Å–ø–∏—Å–æ–∫ –∏–ª–∏ "–Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã"]
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: [—á—Ç–æ —É–ª—É—á—à–∏—Ç—å]'''
    },
    'recommendations': {
        'description': '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –Ω–æ–≤–æ—Å—Ç–∏',
        'prompt': '''–í—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞.
–í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –Ω–æ–≤–æ—Å—Ç–∏.

–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ:
1. –ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å (–Ω–µ–¥–æ—Å—Ç–∞—é—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ–Ω—Ç–µ–∫—Å—Ç)
2. –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –∞–∫—Ü–µ–Ω—Ç—ã)
3. –ß—Ç–æ —É–±—Ä–∞—Ç—å (–∏–∑–±—ã—Ç–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –ø–æ–≤—Ç–æ—Ä—ã)
4. –ö–∞–∫ —É–ª—É—á—à–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
5. –ö–∞–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–ó–∞–≥–æ–ª–æ–≤–æ–∫: [—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏]
–°—Ç—Ä—É–∫—Ç—É—Ä–∞: [—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏]
–î–æ–±–∞–≤–∏—Ç—å: [—Å–ø–∏—Å–æ–∫]
–ò–∑–º–µ–Ω–∏—Ç—å: [—Å–ø–∏—Å–æ–∫]
–£–±—Ä–∞—Ç—å: [—Å–ø–∏—Å–æ–∫]
–ò—Å—Ç–æ—á–Ω–∏–∫–∏: [–∫–∞–∫–∏–µ –¥–æ–±–∞–≤–∏—Ç—å]
–û–±—â–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: [–∫—Ä–∞—Ç–∫–∏–π –∏—Ç–æ–≥]'''
    }
}


def init_system_prompts():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã"""
    print("\n" + "=" * 60)
    print("–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–ù–´–• –ü–†–û–ú–ü–¢–û–í")
    print("=" * 60)

    stages = Stage.query.all()

    if not stages:
        print("‚ö†Ô∏è  –≠—Ç–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!")
        print("   –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —ç—Ç–∞–ø—ã —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å")
        return

    created = 0
    updated = 0
    skipped = 0

    for stage in stages:
        if stage.name in DEFAULT_PROMPTS:
            prompt_data = DEFAULT_PROMPTS[stage.name]
            existing = SystemPrompt.query.filter_by(stage_id=stage.id).first()

            if existing:
                print(f"‚ö†Ô∏è  –ü—Ä–æ–º–ø—Ç –¥–ª—è '{stage.display_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                skipped += 1
            else:
                system_prompt = SystemPrompt(
                    stage_id=stage.id,
                    prompt_text=prompt_data['prompt'],
                    description=prompt_data['description']
                )
                db.session.add(system_prompt)
                print(f"‚úÖ –°–æ–∑–¥–∞–Ω –ø—Ä–æ–º–ø—Ç –¥–ª—è '{stage.display_name}'")
                created += 1
        else:
            print(f"‚ö†Ô∏è  –ù–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —ç—Ç–∞–ø–∞ '{stage.name}'")

    db.session.commit()

    print("\n" + "=" * 60)
    print(f"–°–æ–∑–¥–∞–Ω–æ: {created}")
    print(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ: {updated}")
    print(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped}")
    print("=" * 60)


def init_user_prompts():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    print("\n" + "=" * 60)
    print("–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–û–ú–ü–¢–û–í –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô")
    print("=" * 60)

    users = User.query.all()

    if not users:
        print("‚ö†Ô∏è  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!")
        return

    print(f"–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(users)}")

    for user in users:
        print(f"\nüë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.email}")
        try:
            PromptManager.initialize_user_prompts(user.id)
            print(f"   ‚úÖ –ü—Ä–æ–º–ø—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")
        except Exception as e:
            print(f"   ‚ùå –û—à–∏–±–∫–∞: {e}")

    print("\n" + "=" * 60)
    print("‚úÖ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê")
    print("=" * 60)


if __name__ == "__main__":
    app = create_app()

    with app.app_context():
        print("\n" + "üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–û–ú–ü–¢–û–í ".center(60, "="))

        # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
        init_system_prompts()

        # –ó–∞—Ç–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        init_user_prompts()

        print("\n" + "=" * 60)
        print("‚úÖ –í–°–Å –ì–û–¢–û–í–û!")
        print("=" * 60 + "\n")